<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å…«å­—æ‹©å‰ä»»åŠ¡æ¨è</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      font-size: 1.1em;
    }
    
    input, select, button {
      padding: 12px;
      font-size: 16px;
      width: 100%;
      max-width: 400px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 20px;
      transition: transform 0.2s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    #result {
      margin-top: 30px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.8;
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
      border-left: 5px solid #667eea;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .loading {
      text-align: center;
      color: #667eea;
      font-size: 1.2em;
    }
    
    .error {
      color: #e74c3c;
      background: #fdf2f2;
      border-left-color: #e74c3c;
    }
    
    .success {
      color: #27ae60;
    }
    
    .highlight {
      background: #fff3cd;
      padding: 2px 4px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”® Academic god</h1>

    <div class="form-group">
      <label for="birth">ğŸ“… å‡ºç”Ÿæ—¥æœŸæ—¶é—´</label>
      <input type="datetime-local" id="birth" />
    </div>

    <div class="form-group">
      <label for="gender">ğŸ‘¤ æ€§åˆ«</label>
      <select id="gender">
        <option value="1">ç”·</option>
        <option value="0">å¥³</option>
      </select>
    </div>

    <div class="form-group">
      <label for="task">ğŸ“ ä»»åŠ¡ç±»å‹</label>
      <select id="task">
        <option value="æŠ•ç¨¿">ğŸ“„ æŠ•ç¨¿</option>
        <option value="è¿”ä¿®">âœï¸ è¿”ä¿®</option>
        <option value="ç›²å®¡">ğŸ‘ï¸ ç›²å®¡</option>
        <option value="ç­”è¾©">ğŸ“ ç­”è¾©</option>
      </select>
    </div>

    <div class="form-group">
      <label for="days">ğŸ“Š åˆ†æå¤©æ•°ï¼ˆ1-365å¤©ï¼‰</label>
      <input type="number" id="days" min="1" max="365" value="30" />
    </div>

    <button onclick="submitForm()">ğŸš€ å¼€å§‹åˆ†æ</button>

    <div id="result"></div>
  </div>

  <script src="lunar.js"></script>
  <script>
    // ==================== å…«å­—è®¡ç®—æ ¸å¿ƒå¸¸é‡ ====================
    // (ä¿ç•™éƒ¨åˆ†ç”¨äºæ—ºè¡°åˆ†æå’Œè‡ªå®šä¹‰åç¥è®¡ç®—)
    const TIANGAN = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
    const DIZHI = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    
    const GAN_WUXING = {
      "ç”²": "æœ¨", "ä¹™": "æœ¨", "ä¸™": "ç«", "ä¸": "ç«", "æˆŠ": "åœŸ", "å·±": "åœŸ",
      "åºš": "é‡‘", "è¾›": "é‡‘", "å£¬": "æ°´", "ç™¸": "æ°´"
    };
    
    const ZHI_WUXING = { //åœ°æ”¯æœ¬æ°”äº”è¡Œ
      "å­": "æ°´", "ä¸‘": "åœŸ", "å¯…": "æœ¨", "å¯": "æœ¨",
      "è¾°": "åœŸ", "å·³": "ç«", "åˆ": "ç«", "æœª": "åœŸ",
      "ç”³": "é‡‘", "é…‰": "é‡‘", "æˆŒ": "åœŸ", "äº¥": "æ°´"
    };

    const GAN_YINYANG = {
      "ç”²": "é˜³", "ä¹™": "é˜´", "ä¸™": "é˜³", "ä¸": "é˜´", "æˆŠ": "é˜³", "å·±": "é˜´",
      "åºš": "é˜³", "è¾›": "é˜´", "å£¬": "é˜³", "ç™¸": "é˜´"
    };
    
    const SHENG_MAP = {"æœ¨": "ç«", "ç«": "åœŸ", "åœŸ": "é‡‘", "é‡‘": "æ°´", "æ°´": "æœ¨"}; // æˆ‘ç”Ÿè€…
    const KE_MAP = {"æœ¨": "åœŸ", "ç«": "é‡‘", "åœŸ": "æ°´", "é‡‘": "æœ¨", "æ°´": "ç«"};   // æˆ‘å…‹è€…
    const SHENG_WO_MAP = Object.fromEntries(Object.entries(SHENG_MAP).map(([k, v]) => [v, k])); // ç”Ÿæˆ‘è€…
    const KE_WO_MAP = Object.fromEntries(Object.entries(KE_MAP).map(([k, v]) => [v, k]));     // å…‹æˆ‘è€…

    // è¿åŠ¿è§£é‡Š
    const YUNSHI_JIESHI = {
      "æ¯”è‚©": "è‡ªæˆ‘å¼ºåŒ–ä¹‹è¿ï¼Œé€‚åˆç‹¬ç«‹åˆ›ä¸šã€è‡ªä¸»å†³ç­–",
      "åŠ«è´¢": "ç«äº‰å‹åŠ›ä¹‹è¿ï¼Œéœ€æ³¨æ„åˆä½œå…³ç³»ä¸è´¢åŠ¡é£é™©",
      "é£Ÿç¥": "å®‰é€¸äº«ä¹ä¹‹è¿ï¼Œé€‚åˆåˆ›æ„è¡¨è¾¾ã€å­¦æœ¯æˆé•¿",
      "ä¼¤å®˜": "æ‰åé‡Šæ”¾ä¹‹è¿ï¼Œåˆ©äºå±•ç¤ºèƒ½åŠ›ï¼Œéœ€æ³¨æ„å¾—ç½ªæƒå¨",
      "æ­£è´¢": "ç¨³å¥æ±‚è´¢ä¹‹è¿ï¼Œé€‚åˆæŠ•èµ„ç†è´¢ã€ç§¯ç´¯è´¢å¯Œ",
      "åè´¢": "åé—¨ä¹‹è´¢ä¹‹è¿ï¼Œé€‚åˆæ¥è§¦æœºä¼šå‹é¡¹ç›®æˆ–è·¨ç•Œæ”¶ç›Š",
      "æ­£å®˜": "è§„èŒƒæˆé•¿ä¹‹è¿ï¼Œé€‚åˆæ™‹å‡è€ƒè¯•ã€å…¬åŠ¡ç”³æŠ¥ç­‰",
      "ä¸ƒæ€": "å‹åŠ›æŒ‘æˆ˜ä¹‹è¿ï¼Œåˆ©äºçªç ´ç“¶é¢ˆã€å±•ç°é¢†å¯¼åŠ›",
      "æ­£å°": "å­¦ä¹ ç§¯ç´¯ä¹‹è¿ï¼Œåˆ©äºæ·±é€ ã€æå‡å­¦å†ä¸èµ„å†",
      "åå°": "çµæ„Ÿä¸å†…çœä¹‹è¿ï¼Œé€‚åˆç ”ç©¶ã€å†™ä½œã€é™å¿ƒä¿®ç‚¼"
    };
    
    // å­¦æœ¯/äº‹ä¸šæ˜Ÿå«ä¹‰
    const CAREER_STAR_MEANING = {
      "é£Ÿç¥": "é€‚åˆåˆ›ä½œã€å†™ä½œã€äº«å—å­¦æœ¯å¸¦æ¥çš„æˆæœ",
      "ä¼¤å®˜": "åˆ©äºå‘è¡¨ã€è¾©è®ºã€å±•ç¤ºæ‰åï¼Œéœ€æ³¨æ„è¨€è¾é”‹èŠ’",
      "æ­£å°": "åˆ©äºå­¦ä¹ è€ƒè¯•ã€å–å¾—èµ„è´¨ã€å¸ˆæ‰¿ã€å­¦ä½",
      "ä¸ƒæ€": "é€‚åˆçªç ´å‹åŠ›æŒ‘æˆ˜ï¼Œæœ‰æœ›è„±é¢–è€Œå‡º"
    };
    
    // ç¥ç…æ•°æ® (ç”¨äºæ‹©å‰)
    const TASK_YI_JISHEN = {
      "æŠ•ç¨¿": new Set(["æ–‡æ˜Œ", "å¤©ä¹™", "å­¦å ‚", "ç‰å ‚", "é‡‘åŒ®", "æœˆæ©", "å¤©å¾·", "é’é¾™"]),
      "è¿”ä¿®": new Set(["å¤©å¾·", "æœˆå¾·", "å…­åˆ", "è§£ç¥", "æ—¶å¾·", "æ—¶é˜³", "å¤©èµ¦", "ç‰å ‚"]),
      "ç›²å®¡": new Set(["é‡‘åŒ®", "å¤©ä¹™", "é’é¾™", "æ˜å ‚", "å¤©æ©", "å¤©å–œ", "ç¦ç”Ÿ", "ç‹æ—¥"]),
      "ç­”è¾©": new Set(["æ–‡æ˜Œ", "ä¸‰å¥‡", "å¤©å–œ", "é‡‘åŒ®", "ç‰å ‚", "å¤©åŒ»", "å¤©èµ¦", "æ˜å ‚", "å¤©å¾·åˆ"])
    };
    
    const TASK_JI_XIONGSHA = {
      "æŠ•ç¨¿": new Set(["å¤©è´¼", "æŠ«éº»", "ç ´æ—¥", "æ­»ç¥", "å°è€—", "æœˆç…", "åŠ«ç…", "è¡€å¿Œ"]),
      "è¿”ä¿®": new Set(["æœˆç ´", "æ—¥ç ´", "æ—¬ç©º", "å¤©è´¼", "å¤æ—¥", "æ­»æ°”", "æœˆåŒ", "æœˆå®³"]),
      "ç›²å®¡": new Set(["æŠ«éº»", "åŠ«ç…", "æœˆç…", "æ­»æ°”", "äº”é¬¼", "å¤©ç‹—", "ç™½è™"]),
      "ç­”è¾©": new Set(["å¤©è´¼", "æ­»æ°”", "äº”é¬¼", "æœˆåŒ", "æœ±é›€", "åœ°ç«", "ç™½è™", "å­¤é˜³"])
    };

    // ==================== å…«å­—è®¡ç®—è¾…åŠ©å‡½æ•° ====================

    // è®¡ç®—ä»»æ„å¤©å¹²ç›¸å¯¹äºç‰¹å®šæ—¥ä¸»å¤©å¹²çš„åç¥
    function calculateTenGodForExternalGan(dayMasterGan, targetGan) {
      if (!dayMasterGan || !targetGan) return "æœªçŸ¥";
      const dmWuXing = GAN_WUXING[dayMasterGan];
      const tgWuXing = GAN_WUXING[targetGan];
      const dmYinYang = GAN_YINYANG[dayMasterGan];
      const tgYinYang = GAN_YINYANG[targetGan];

      if (!dmWuXing || !tgWuXing || !dmYinYang || !tgYinYang) return "æœªçŸ¥";

      const isSameYinYang = dmYinYang === tgYinYang;

      if (tgWuXing === dmWuXing) { // åŒæˆ‘è€…
        return isSameYinYang ? "æ¯”è‚©" : "åŠ«è´¢";
      } else if (SHENG_MAP[dmWuXing] === tgWuXing) { // æˆ‘ç”Ÿè€…
        return isSameYinYang ? "é£Ÿç¥" : "ä¼¤å®˜";
      } else if (SHENG_WO_MAP[dmWuXing] === tgWuXing) { // ç”Ÿæˆ‘è€…
        return isSameYinYang ? "åå°" : "æ­£å°";
      } else if (KE_MAP[dmWuXing] === tgWuXing) { // æˆ‘å…‹è€…
        return isSameYinYang ? "åè´¢" : "æ­£è´¢";
      } else if (KE_WO_MAP[dmWuXing] === tgWuXing) { // å…‹æˆ‘è€…
        return isSameYinYang ? "ä¸ƒæ€" : "æ­£å®˜";
      }
      return "æœªçŸ¥";
    }
    
    // åˆ†æäº”è¡Œå¼ºå¼± (ä½¿ç”¨lunar.jsè·å–åŸºç¡€æ•°æ®)
    function analyzeWuXingStrength(eightChar) {
      const dayGan = eightChar.getDayGan();
      const dayGanWuXing = GAN_WUXING[dayGan];
      
      const wuxingCount = {"æœ¨": 0, "ç«": 0, "åœŸ": 0, "é‡‘": 0, "æ°´": 0};

      // ç»Ÿè®¡å››æŸ±å¤©å¹²äº”è¡Œ
      [eightChar.getYearGan(), eightChar.getMonthGan(), eightChar.getDayGan(), eightChar.getTimeGan()].forEach(gan => {
        if (GAN_WUXING[gan]) wuxingCount[GAN_WUXING[gan]]++;
      });

      // ç»Ÿè®¡å››æŸ±åœ°æ”¯è—å¹²äº”è¡Œ (æœ¬æ°”ã€ä¸­æ°”ã€ä½™æ°”å‡ç»Ÿè®¡)
      [eightChar.getYearHideGan(), eightChar.getMonthHideGan(), eightChar.getDayHideGan(), eightChar.getTimeHideGan()].forEach(hideGans => {
        hideGans.forEach(gan => {
          if (GAN_WUXING[gan]) wuxingCount[GAN_WUXING[gan]]++;
        });
      });
      
      // å¾—ä»¤åˆ¤æ–­: æ—¥å¹²åœ¨æœˆä»¤çš„æ—ºè¡° (å‚è€ƒæœˆæ”¯è—å¹²å’ŒæœˆæŸ±åœ°åŠ¿)
      // æœˆä»¤ä¸»æ°”ç”ŸåŠ©æ—¥å¹²ï¼Œæˆ–æœˆä»¤ä¸ºæ—¥å¹²çš„ç¦„åˆƒï¼ˆé•¿ç”Ÿã€æ²æµ´ã€å† å¸¦ã€ä¸´å®˜ã€å¸æ—ºï¼‰
      const monthZhi = eightChar.getMonthZhi();
      const monthHideGans = eightChar.getMonthHideGan(); // æœˆæ”¯è—å¹²
      const monthDiShi = eightChar.getMonthDiShi(); // æœˆæŸ±åœ°åŠ¿ï¼Œç›¸å¯¹äºæœˆæŸ±å¹²æ”¯ï¼Œä¸æ˜¯æ—¥å¹²åœ¨æœˆä»¤çš„åœ°åŠ¿
      
      // æ›´å‡†ç¡®çš„å¾—ä»¤åˆ¤æ–­ï¼šæ—¥å¹²åœ¨æœˆä»¤ï¼ˆæœˆæ”¯ï¼‰æ˜¯å¦å½“æƒï¼ˆå³æœˆæ”¯çš„æœ¬æ°”äº”è¡Œæ˜¯å¦ä¸ºæ—¥å¹²çš„å°æ¯”ï¼‰
      // æˆ–è€…æœˆæ”¯æœ¬èº«å°±æ˜¯æ—¥å¹²çš„å¼ºæ ¹ï¼ˆç¦„ã€æ—ºã€é•¿ç”Ÿç­‰ï¼‰
      // lunar.js çš„ getDayDiShi() æ˜¯æ—¥æŸ±åœ°åŠ¿ï¼Œæˆ‘ä»¬éœ€è¦æ—¥å¹²åœ¨æœˆã€å¹´ã€æ—¶æ”¯çš„åœ°åŠ¿ï¼Œlunar.jsä¼¼ä¹ä¸ç›´æ¥æä¾›è¿™ä¸ªã€‚
      // ç®€åŒ–åˆ¤æ–­ï¼šæœˆæ”¯æœ¬æ°”äº”è¡Œæ˜¯å¦ç”ŸåŠ©æ—¥å¹²äº”è¡Œ
      let deLing = false;
      const monthZhiWuXing = ZHI_WUXING[monthZhi]; // æœˆæ”¯æœ¬æ°”äº”è¡Œ
      if (monthZhiWuXing === dayGanWuXing || SHENG_WO_MAP[dayGanWuXing] === monthZhiWuXing) {
        deLing = true;
      }
      // ä¹Ÿå¯å‚è€ƒæœˆæ”¯è—å¹²æ˜¯å¦æœ‰æ—¥å¹²çš„å°æ˜Ÿæˆ–æ¯”åŠ«
      if (!deLing && monthHideGans.some(hg => GAN_WUXING[hg] === dayGanWuXing || SHENG_WO_MAP[dayGanWuXing] === GAN_WUXING[hg])) {
        deLing = true;
      }

      // å¾—åœ°åˆ¤æ–­: æ—¥å¹²åœ¨å¹´æ”¯ã€æ—¥æ”¯ã€æ—¶æ”¯æœ‰æ ¹ (æœ¬æ°”æ ¹ã€ä¸­æ°”æ ¹ã€ä½™æ°”æ ¹ï¼Œæˆ–ä¸ºå°æ¯”)
      let deDiCount = 0;
      [eightChar.getYearZhi(), eightChar.getDayZhi(), eightChar.getTimeZhi()].forEach(zhi => {
        const hideGans = zhi === eightChar.getYearZhi() ? eightChar.getYearHideGan() : 
                         (zhi === eightChar.getDayZhi() ? eightChar.getDayHideGan() : eightChar.getTimeHideGan());
        if (hideGans.some(hg => GAN_WUXING[hg] === dayGanWuXing)) deDiCount++; // æœ‰åŒç±»äº”è¡Œæ ¹
        else if (hideGans.some(hg => SHENG_WO_MAP[dayGanWuXing] === GAN_WUXING[hg])) deDiCount++; // æœ‰ç”Ÿæˆ‘ä¹‹å°çš„æ ¹
      });
      const deDi = deDiCount > 0;
      
      // å¾—åŠ©åˆ¤æ–­: å¹´å¹²ã€æœˆå¹²ã€æ—¶å¹²æœ‰å°æ¯”ç”ŸåŠ©
      let deZhuCount = 0;
      [eightChar.getYearGan(), eightChar.getMonthGan(), eightChar.getTimeGan()].forEach(gan => {
        if (gan === dayGan) return; // ä¸è®¡æ—¥å¹²æœ¬èº«
        const ganWuXing = GAN_WUXING[gan];
        if (ganWuXing === dayGanWuXing || SHENG_WO_MAP[dayGanWuXing] === ganWuXing) deZhuCount++;
      });
      const deZhu = deZhuCount > 0;
      
      const strengthScore = (deLing ? 1.5 : 0) + (deDiCount * 0.75) + (deZhuCount * 0.5); // ç®€å•åŠ æƒ
      
      let status;
      if (strengthScore >= 2.0) status = "æ—¥ä¸»åå¼º";
      else if (strengthScore >= 1.0) status = "ä¸­å’Œ";
      else status = "æ—¥ä¸»åå¼±";
      
      let yongShen = [], jiShen = [], xiShen = [];
      if (status === "æ—¥ä¸»åå¼º") {
        yongShen = [KE_MAP[dayGanWuXing], SHENG_MAP[dayGanWuXing], "æ°´"]; // å…‹æˆ‘ã€æˆ‘ç”Ÿã€è°ƒå€™ï¼ˆæ°´ï¼‰
        jiShen = [dayGanWuXing, SHENG_WO_MAP[dayGanWuXing]]; // åŒæˆ‘ã€ç”Ÿæˆ‘
        xiShen = yongShen; // å–œç¥é€šå¸¸æ˜¯ç”¨ç¥çš„åŒç±»æˆ–ç”Ÿç”¨ç¥çš„äº”è¡Œ
      } else if (status === "æ—¥ä¸»åå¼±") {
        yongShen = [dayGanWuXing, SHENG_WO_MAP[dayGanWuXing]]; // åŒæˆ‘ã€ç”Ÿæˆ‘
        jiShen = [KE_MAP[dayGanWuXing], SHENG_MAP[dayGanWuXing], KE_WO_MAP[dayGanWuXing]]; // å…‹æˆ‘ã€æˆ‘ç”Ÿã€æ³„æˆ‘
        xiShen = yongShen;
      } else { // ä¸­å’Œ
        // ä¸­å’Œä»¥æµé€šå¹³è¡¡ä¸ºè¦ï¼Œå¯èƒ½éœ€è¦æ ¹æ®å…·ä½“äº”è¡Œç»„åˆç»†è°ƒ
        // ç®€å•å¤„ç†ï¼šæ‰¶æŠ‘ä¸¤ç”¨ï¼Œæˆ–å–è°ƒå€™ç”¨ç¥
        yongShen = ["è°ƒå’Œå…¨å±€"];
        xiShen = ["è§†å±€è€Œå®š"];
        jiShen = ["å¤ªè¿‡æˆ–ä¸åŠä¹‹äº”è¡Œ"];
      }
      // ç§»é™¤é‡å¤é¡¹å¹¶ç¡®ä¿ç”¨ç¥ä¸è¶…è¿‡2-3ä¸ªä¸»æµ
      yongShen = [...new Set(yongShen)].slice(0,3);
      jiShen = [...new Set(jiShen)].slice(0,3);

      return {
        dayGan,
        dayGanWuXing,
        status,
        wuxingCount,
        yongShen,
        xiShen,
        jiShen,
        deLing,
        deDi,
        deZhu
      };
    }
        
    // ç®€åŒ–çš„ç¥ç…è®¡ç®— (ç”¨äºæ‹©å‰ï¼Œlunar.jsä¸ç›´æ¥æä¾›æ¯æ—¥å®Œæ•´ç¥ç…)
    function calculateShenSha(targetDateStr, task) {
      const date = new Date(targetDateStr); // ç¡®ä¿ä¼ å…¥çš„æ˜¯æ—¥æœŸå¯¹è±¡æˆ–å¯è§£æçš„å­—ç¬¦ä¸²
      const allJiShen = ["æ–‡æ˜Œ", "å¤©ä¹™", "å­¦å ‚", "ç‰å ‚", "é‡‘åŒ®", "æœˆæ©", "å¤©å¾·", "é’é¾™", "æ˜å ‚", "å¤©æ©", "å¤©å–œ", "ç¦ç”Ÿ", "ç‹æ—¥", "è§£ç¥", "æœˆå¾·", "å…­åˆ", "æ—¶å¾·", "æ—¶é˜³", "å¤©èµ¦", "ä¸‰å¥‡", "å¤©åŒ»", "å¤©å¾·åˆ"];
      const allXiongSha = ["å¤©è´¼", "æŠ«éº»", "ç ´æ—¥", "æ­»ç¥", "å°è€—", "æœˆç…", "åŠ«ç…", "è¡€å¿Œ", "æœˆç ´", "æ—¥ç ´", "æ—¬ç©º", "å¤æ—¥", "æ­»æ°”", "æœˆåŒ", "æœˆå®³", "äº”é¬¼", "å¤©ç‹—", "ç™½è™", "æœ±é›€", "åœ°ç«", "å­¤é˜³"];
      
      const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
      const jiShenCount = (dayOfYear % 5) + 2; // å¢åŠ å‰ç¥æ•°é‡
      const xiongShaCount = (dayOfYear % 3) + 1;
      
      const jiShen = [];
      const xiongSha = [];
      
      for (let i = 0; i < jiShenCount; i++) {
        const index = (dayOfYear * 3 + i * 5) % allJiShen.length;
        if (!jiShen.includes(allJiShen[index])) jiShen.push(allJiShen[index]);
      }
      
      for (let i = 0; i < xiongShaCount; i++) {
        const index = (dayOfYear * 2 + i * 3) % allXiongSha.length;
        if (!xiongSha.includes(allXiongSha[index])) xiongSha.push(allXiongSha[index]);
      }
      
      return { jiShen, xiongSha };
    }
    
    // æ‹©å‰è¯„åˆ†ç®—æ³•
    function evaluateDayForTask(targetDateStr, task, yongShen, jiShen, dayMasterGan, currentDaYunTenGod, currentLiuNianTenGod, currentLiuYueTenGod) {
      try {
        const solarDate = Solar.fromDate(new Date(targetDateStr));
        const eightCharToday = Lunar.fromDate(new Date(targetDateStr)).getEightChar();
        eightCharToday.setSect(2); // ç¡®ä¿æµæ´¾ä¸€è‡´

        const dayGanCurr = eightCharToday.getDayGan();
        const dayZhiCurr = eightCharToday.getDayZhi();
        const dayGanWx = GAN_WUXING[dayGanCurr];
        const dayZhiWx = ZHI_WUXING[dayZhiCurr]; //åœ°æ”¯æœ¬æ°”äº”è¡Œ
        
        const shenSha = calculateShenSha(targetDateStr, task);
        const jiShenSet = new Set(shenSha.jiShen);
        const xiongShaSet = new Set(shenSha.xiongSha);
        
        let score = 50; // Base score
        
        // ç¥ç…è¯„åˆ†
        const taskYiJiShen = TASK_YI_JISHEN[task] || new Set();
        const taskJiXiongSha = TASK_JI_XIONGSHA[task] || new Set();
        
        score += Array.from(jiShenSet).filter(x => taskYiJiShen.has(x)).length * 15;
        score -= Array.from(xiongShaSet).filter(x => taskJiXiongSha.has(x)).length * 20;
        
        // ç”¨ç¥ä¸å¿Œç¥è¯„åˆ† (å½“æ—¥å¹²æ”¯äº”è¡Œå¯¹å‘½ä¸»çš„å½±å“)
        if (yongShen.includes(dayGanWx)) score += 20;
        if (yongShen.includes(dayZhiWx)) score += 10;
        if (jiShen.includes(dayGanWx)) score -= 25;
        if (jiShen.includes(dayZhiWx)) score -= 15;

        // å½“æ—¥å¹²æ”¯ä¸å‘½ä¸»æ—¥å¹²çš„å…³ç³»
        const todayDayGanToDM = calculateTenGodForExternalGan(dayMasterGan, dayGanCurr);
        if (["æ­£è´¢", "åè´¢", "é£Ÿç¥", "æ­£å®˜", "æ­£å°"].includes(todayDayGanToDM)) score += 10;
        if (["åŠ«è´¢", "ä¼¤å®˜", "ä¸ƒæ€", "åå°"].includes(todayDayGanToDM)) score -= 5;

        // è€ƒè™‘å½“å‰å¤§è¿ã€æµå¹´ã€æµæœˆåç¥å¯¹å½“æ—¥çš„è¾…åŠ©ä½œç”¨ (å¦‚æœå®ƒä»¬æ˜¯å‰åç¥)
        [currentDaYunTenGod, currentLiuNianTenGod, currentLiuYueTenGod].forEach(tg => {
          if (["æ­£è´¢", "åè´¢", "é£Ÿç¥", "æ­£å®˜", "æ­£å°"].includes(tg)) {
            score += 5;
          }
        });
        
        return {
          date: targetDateStr, // Keep original string for consistency
          ganzhi: dayGanCurr + dayZhiCurr,
          jiShen: Array.from(jiShenSet),
          xiongSha: Array.from(xiongShaSet),
          wuxing: `${dayGanWx}/${dayZhiWx}`,
          score: Math.max(0, Math.round(score)) // Ensure score is not negative
        };
      } catch (e) {
        return {
          date: targetDateStr,
          ganzhi: "è®¡ç®—å¤±è´¥",
          jiShen: [],
          xiongSha: [],
          wuxing: "æœªçŸ¥/æœªçŸ¥",
          score: 0,
          error: e.message
        };
      }
    }
    
    // ==================== ä¸»åˆ†æå‡½æ•° ====================
    
    function runBaziAnalysis(birthDateTime, gender, task, analysisDays, currentTime) {
      const ê²°ê³¼ = { // Renamed to avoid conflict with element id 'result'
        dateRecPrints: [],
        baziPrints: [],
        daYunPrints: [],
        data: {} // For structured data if needed later
      };
      
      try {
        const solarBirth = Solar.fromDate(birthDateTime);
        const lunarBirth = Lunar.fromDate(birthDateTime);
        const eightChar = lunarBirth.getEightChar();
        eightChar.setSect(2); // è®¾ç½®å…«å­—æµæ´¾ä¸º2

        ê²°ê³¼.baziPrints.push("âœ¨ å…«å­—åˆ†æ âœ¨\n" + "=".repeat(30));
        ê²°ê³¼.baziPrints.push(`å…¬å†ç”Ÿæ—¥: ${solarBirth.toString()}`);
        ê²°ê³¼.baziPrints.push(`å†œå†ç”Ÿæ—¥: ${lunarBirth.toString()} (${lunarBirth.getYearInGanZhi()} ${lunarBirth.getMonthInGanZhi()} ${lunarBirth.getDayInGanZhi()})`);
        ê²°ê³¼.baziPrints.push(`ç”Ÿè‚–: ${lunarBirth.getYearShengXiao()} | æ˜Ÿåº§: ${solarBirth.getXingZuo()}`);
        
        const yearGZ = eightChar.getYear();
        const monthGZ = eightChar.getMonth();
        const dayGZ = eightChar.getDay();
        const timeGZ = eightChar.getTime();
        ê²°ê³¼.baziPrints.push(`\nã€å››æŸ±å¹²æ”¯ã€‘`);
        ê²°ê³¼.baziPrints.push(`å¹´æŸ±: ${yearGZ} (æ—¬ç©º:${eightChar.getYearXunKong()}) (åœ°åŠ¿:${eightChar.getYearDiShi()})`);
        ê²°ê³¼.baziPrints.push(`æœˆæŸ±: ${monthGZ} (æ—¬ç©º:${eightChar.getMonthXunKong()}) (åœ°åŠ¿:${eightChar.getMonthDiShi()})`);
        ê²°ê³¼.baziPrints.push(`æ—¥æŸ±: ${dayGZ} (æ—¬ç©º:${eightChar.getDayXunKong()}) (åœ°åŠ¿:${eightChar.getDayDiShi()})`);
        ê²°ê³¼.baziPrints.push(`æ—¶æŸ±: ${timeGZ} (æ—¬ç©º:${eightChar.getTimeXunKong()}) (åœ°åŠ¿:${eightChar.getTimeDiShi()})`);

        ê²°ê³¼.baziPrints.push(`\nã€çº³éŸ³ã€‘`);
        ê²°ê³¼.baziPrints.push(`å¹´æŸ±çº³éŸ³: ${eightChar.getYearNaYin()} (${eightChar.getYearWuXing()})`);
        ê²°ê³¼.baziPrints.push(`æœˆæŸ±çº³éŸ³: ${eightChar.getMonthNaYin()} (${eightChar.getMonthWuXing()})`);
        ê²°ê³¼.baziPrints.push(`æ—¥æŸ±çº³éŸ³: ${eightChar.getDayNaYin()} (${eightChar.getDayWuXing()})`);
        ê²°ê³¼.baziPrints.push(`æ—¶æŸ±çº³éŸ³: ${eightChar.getTimeNaYin()} (${eightChar.getTimeWuXing()})`);

        ê²°ê³¼.baziPrints.push(`\nã€åç¥ã€‘(ç›¸å¯¹äºæ—¥ä¸» ${eightChar.getDayGan()})`);
        ê²°ê³¼.baziPrints.push(`å¹´æŸ±åç¥: å¹²[${eightChar.getYearShiShenGan()}] æ”¯[${eightChar.getYearShiShenZhi().join(',')}]`);
        ê²°ê³¼.baziPrints.push(`æœˆæŸ±åç¥: å¹²[${eightChar.getMonthShiShenGan()}] æ”¯[${eightChar.getMonthShiShenZhi().join(',')}]`);
        ê²°ê³¼.baziPrints.push(`æ—¥æŸ±åç¥: å¹²[${eightChar.getDayShiShenGan()}] æ”¯[${eightChar.getDayShiShenZhi().join(',')}]`);
        ê²°ê³¼.baziPrints.push(`æ—¶æŸ±åç¥: å¹²[${eightChar.getTimeShiShenGan()}] æ”¯[${eightChar.getTimeShiShenZhi().join(',')}]`);
        
        const qiangruo = analyzeWuXingStrength(eightChar);
        ê²°ê³¼.data.qiangruo = qiangruo; // Store for later use in evaluateDayForTask

        ê²°ê³¼.baziPrints.push(`\nã€æ—¥ä¸»æ—ºè¡°åˆ†æã€‘`);
        ê²°ê³¼.baziPrints.push(`æ—¥ä¸»: ${qiangruo.dayGan} (äº”è¡Œï¼š${qiangruo.dayGanWuXing})`);
        ê²°ê³¼.baziPrints.push(`æ—ºè¡°: ${qiangruo.status} (å¾—ä»¤:${qiangruo.deLing}, å¾—åœ°:${qiangruo.deDi}, å¾—åŠ©:${qiangruo.deZhu})`);
        ê²°ê³¼.baziPrints.push(`äº”è¡Œä¸ªæ•°: æœ¨:${qiangruo.wuxingCount['æœ¨']}, ç«:${qiangruo.wuxingCount['ç«']}, åœŸ:${qiangruo.wuxingCount['åœŸ']}, é‡‘:${qiangruo.wuxingCount['é‡‘']}, æ°´:${qiangruo.wuxingCount['æ°´']}`);
        ê²°ê³¼.baziPrints.push(`ç”¨ç¥å‚è€ƒ: ${qiangruo.yongShen.join(', ')}`);
        ê²°ê³¼.baziPrints.push(`å–œç¥å‚è€ƒ: ${qiangruo.xiShen.join(', ')}`);
        ê²°ê³¼.baziPrints.push(`å¿Œç¥å‚è€ƒ: ${qiangruo.jiShen.join(', ')}`);

        ê²°ê³¼.baziPrints.push(`\nã€å…¶ä»–ç¥ç…å‚è€ƒã€‘`);
        ê²°ê³¼.baziPrints.push(`èƒå…ƒ: ${eightChar.getTaiYuan()} | å‘½å®«: ${eightChar.getMingGong()} | èº«å®«: ${eightChar.getShenGong()}`);


        // å¤§è¿ã€æµå¹´ã€å°è¿ã€æµæœˆåˆ†æ
        ê²°ê³¼.daYunPrints.push("ğŸ“œ å¤§è¿æµå¹´åˆ†æ ğŸ“œ\n" + "=".repeat(30));
        const yun = eightChar.getYun(gender, 1); // èµ·è¿æµæ´¾1
        // æ‰‹åŠ¨è®¡ç®—è™šå²: å½“å‰å¹´ä»½ - å‡ºç”Ÿå¹´ä»½ + 1
        const age = currentTime.getFullYear() - solarBirth.getYear() + 1;
        ê²°ê³¼.daYunPrints.push(`å½“å‰è™šå²: ${age}å²`);
        ê²°ê³¼.daYunPrints.push(`èµ·è¿æ—¶é—´: ${yun.getStartSolar().toString()} (${yun.getStartYear()}å¹´${yun.getStartMonth()}æœˆ${yun.getStartDay()}å¤©å)`);

        const daYunArr = yun.getDaYun();
        let currentDaYunObj = null;
        let currentLiuNianObj = null;
        let currentLiuYueObj = null; // For storing the current LiuYue object if found

        const currentSolarYear = currentTime.getFullYear();

        daYunArr.forEach(dy => {
          ê²°ê³¼.daYunPrints.push(`\n--- ${dy.getStartAge()}å²-${dy.getEndAge()}å² (${dy.getStartYear()}å¹´-${dy.getEndYear()}å¹´) ---`);
          const daYunGanZhi = dy.getGanZhi();
          let daYunTenGod = "æœªçŸ¥";
          let dyXunKong = "æœªçŸ¥";

          if (daYunGanZhi && daYunGanZhi.length === 2) {
            const daYunGan = daYunGanZhi[0];
            daYunTenGod = calculateTenGodForExternalGan(eightChar.getDayGan(), daYunGan);
            try {
              dyXunKong = dy.getXunKong() || "æ— ";
            } catch (e) {
              console.warn(`å¤§è¿ ${daYunGanZhi} (${dy.getStartAge()}å²) æ—¬ç©ºè®¡ç®—é”™è¯¯: ${e.message}`);
              dyXunKong = "è®¡ç®—å¼‚å¸¸";
            }
          } else {
            console.warn(`æ— æ•ˆçš„å¤§è¿å¹²æ”¯: ${daYunGanZhi}ï¼Œå¹´é¾„: ${dy.getStartAge()}å²`);
            dyXunKong = "å¹²æ”¯æ— æ•ˆ";
          }
          ê²°ê³¼.daYunPrints.push(`å¤§è¿: ${daYunGanZhi || "æœªçŸ¥å¹²æ”¯"} (åç¥:${daYunTenGod}) (æ—¬ç©º:${dyXunKong})`);

          if (currentSolarYear >= dy.getStartYear() && currentSolarYear <= dy.getEndYear()) {
            currentDaYunObj = dy;
          }

          const liuNianArr = dy.getLiuNian();
          liuNianArr.slice(0, 3).forEach(ln => { // Display first 3 LiuNian for brevity
            const liuNianGanZhi = ln.getGanZhi();
            let liuNianTenGod = "æœªçŸ¥";
            let lnXunKong = "æœªçŸ¥";

            if (liuNianGanZhi && liuNianGanZhi.length === 2) {
              const liuNianGan = liuNianGanZhi[0];
              liuNianTenGod = calculateTenGodForExternalGan(eightChar.getDayGan(), liuNianGan);
              try {
                lnXunKong = ln.getXunKong() || "æ— ";
              } catch (e) {
                console.warn(`æµå¹´ ${liuNianGanZhi} (${ln.getYear()}å¹´) æ—¬ç©ºè®¡ç®—é”™è¯¯: ${e.message}`);
                lnXunKong = "è®¡ç®—å¼‚å¸¸";
              }
            } else {
               console.warn(`æ— æ•ˆçš„æµå¹´å¹²æ”¯: ${liuNianGanZhi}ï¼Œå¹´ä»½: ${ln.getYear()}`);
               lnXunKong = "å¹²æ”¯æ— æ•ˆ";
            }
            ê²°ê³¼.daYunPrints.push(`  æµå¹´ ${ln.getYear()} (${ln.getAge()}å²): ${liuNianGanZhi || "æœªçŸ¥å¹²æ”¯"} (åç¥:${liuNianTenGod}) (æ—¬ç©º:${lnXunKong})`);
            if (ln.getYear() === currentSolarYear) {
                currentLiuNianObj = ln;
            }
          });
          if (liuNianArr.length > 3) ê²°ê³¼.daYunPrints.push(`  ... (å…± ${liuNianArr.length} æµå¹´)`);

          const xiaoYunArr = dy.getXiaoYun();
           xiaoYunArr.slice(0, 3).forEach(xy => {
            const xiaoYunGanZhi = xy.getGanZhi();
            let xyXunKong = "æœªçŸ¥";
             if (xiaoYunGanZhi && xiaoYunGanZhi.length === 2) {
                try {
                  xyXunKong = xy.getXunKong() || "æ— ";
                } catch (e) {
                  console.warn(`å°è¿ ${xiaoYunGanZhi} (${xy.getYear()}å¹´) æ—¬ç©ºè®¡ç®—é”™è¯¯: ${e.message}`);
                  xyXunKong = "è®¡ç®—å¼‚å¸¸";
                }
             } else {
                console.warn(`æ— æ•ˆçš„å°è¿å¹²æ”¯: ${xiaoYunGanZhi}ï¼Œå¹´ä»½: ${xy.getYear()}`);
                xyXunKong = "å¹²æ”¯æ— æ•ˆ";
             }
            ê²°ê³¼.daYunPrints.push(`  å°è¿ ${xy.getYear()} (${xy.getAge()}å²): ${xiaoYunGanZhi || "æœªçŸ¥å¹²æ”¯"} (æ—¬ç©º:${xyXunKong})`);
          });
          if (xiaoYunArr.length > 3) ê²°ê³¼.daYunPrints.push(`  ... (å…± ${xiaoYunArr.length} å°è¿)`);
        });
        
        // å½“å‰è¿åŠ¿è¯¦ç»†
        ê²°ê³¼.daYunPrints.push(`\nã€å½“å‰è¿åŠ¿è¯¦è§£ã€‘`);
        let currentDaYunTenGod = "æœªçŸ¥", currentLiuNianTenGod = "æœªçŸ¥", currentLiuYueTenGod = "æœªçŸ¥";

        if (currentDaYunObj) {
          const daYunGan = currentDaYunObj.getGanZhi()[0];
          currentDaYunTenGod = calculateTenGodForExternalGan(eightChar.getDayGan(), daYunGan);
          ê²°ê³¼.daYunPrints.push(`å½“å‰å¤§è¿: ${currentDaYunObj.getGanZhi()} (${currentDaYunObj.getStartAge()}-${currentDaYunObj.getEndAge()}å²) (åç¥:${currentDaYunTenGod})`);
          ê²°ê³¼.daYunPrints.push(`  â†’ ${YUNSHI_JIESHI[currentDaYunTenGod] || 'å¹³è¿è¿‡æ¸¡'}`);
        } else {
          ê²°ê³¼.daYunPrints.push(`å½“å‰å¤§è¿: æœªåœ¨æ¨ç®—èŒƒå›´å†…`);
        }
        
        const currentEightChar = Lunar.fromDate(currentTime).getEightChar(); // For current year/month GanZhi
        currentEightChar.setSect(2);

        if (currentLiuNianObj) { // If current LiuNian object was found within a DaYun
             const liuNianGan = currentLiuNianObj.getGanZhi()[0];
             currentLiuNianTenGod = calculateTenGodForExternalGan(eightChar.getDayGan(), liuNianGan);
             ê²°ê³¼.daYunPrints.push(`å½“å‰æµå¹´: ${currentLiuNianObj.getGanZhi()} (${currentLiuNianObj.getYear()}å¹´) (åç¥:${currentLiuNianTenGod})`);
             ê²°ê³¼.daYunPrints.push(`  â†’ ${YUNSHI_JIESHI[currentLiuNianTenGod] || 'å¹³è¿è¿‡æ¸¡'}`);
             // Find current LiuYue from this LiuNian
             const currentMonthLunar = Lunar.fromDate(currentTime).getMonth(); // Lunar month 1-12
             currentLiuNianObj.getLiuYue().forEach(lym => {
                 // lym.getMonthInChinese() is like "æ­£", "äºŒ", ...
                 // We need to match with current lunar month number.
                 // Lunar.js month (1-12) vs lym.getIndex() (0-11) ?
                 // Or match by GanZhi if currentEightChar.getMonth() is reliable
                 if (lym.getGanZhi() === currentEightChar.getMonth()){ // Exact match of GanZhi for current month
                     currentLiuYueObj = lym;
                 }
             });
        } else { // Fallback if not found in DaYun loop (e.g. beforeèµ·è¿)
            const currentYearGanZhi = currentEightChar.getYear();
            const currentYearGan = currentYearGanZhi[0];
            currentLiuNianTenGod = calculateTenGodForExternalGan(eightChar.getDayGan(), currentYearGan);
            ê²°ê³¼.daYunPrints.push(`å½“å‰æµå¹´: ${currentYearGanZhi} (${currentTime.getFullYear()}å¹´) (åç¥:${currentLiuNianTenGod})`);
            ê²°ê³¼.daYunPrints.push(`  â†’ ${YUNSHI_JIESHI[currentLiuNianTenGod] || 'å¹³è¿è¿‡æ¸¡'}`);
        }

        if (currentLiuYueObj) {
            const liuYueGan = currentLiuYueObj.getGanZhi()[0];
            currentLiuYueTenGod = calculateTenGodForExternalGan(eightChar.getDayGan(), liuYueGan);
            ê²°ê³¼.daYunPrints.push(`å½“å‰æµæœˆ: ${currentLiuYueObj.getGanZhi()} (${currentLiuYueObj.getMonthInChinese()}æœˆ) (åç¥:${currentLiuYueTenGod})`);
            ê²°ê³¼.daYunPrints.push(`  â†’ ${YUNSHI_JIESHI[currentLiuYueTenGod] || 'å¹³è¿è¿‡æ¸¡'}`);
        } else { // Fallback for current LiuYue
            const currentMonthGanZhi = currentEightChar.getMonth();
            const currentMonthGan = currentMonthGanZhi[0];
            currentLiuYueTenGod = calculateTenGodForExternalGan(eightChar.getDayGan(), currentMonthGan);
            ê²°ê³¼.daYunPrints.push(`å½“å‰æµæœˆ: ${currentMonthGanZhi} (${Lunar.fromDate(currentTime).getMonthInChinese()}æœˆ) (åç¥:${currentLiuYueTenGod})`);
            ê²°ê³¼.daYunPrints.push(`  â†’ ${YUNSHI_JIESHI[currentLiuYueTenGod] || 'å¹³è¿è¿‡æ¸¡'}`);
        }
        
        ê²°ê³¼.data.currentTengods = { daYun: currentDaYunTenGod, liuNian: currentLiuNianTenGod, liuYue: currentLiuYueTenGod };

        const careerStars = new Set(Object.keys(CAREER_STAR_MEANING));
        const activeStars = { "å¤§è¿": currentDaYunTenGod, "æµå¹´": currentLiuNianTenGod, "æµæœˆ": currentLiuYueTenGod };
        let hasCareerStar = false;
        ê²°ê³¼.daYunPrints.push(`\nğŸ“ å­¦æœ¯/äº‹ä¸šæ˜Ÿæ›œæç¤º:`);
        Object.entries(activeStars).forEach(([period, star]) => {
          if (careerStars.has(star)) {
            ê²°ê³¼.daYunPrints.push(`ã€${period}ã€‘é€¢ã€${star}ã€‘ï¼š${CAREER_STAR_MEANING[star]}`);
            hasCareerStar = true;
          }
        });
        if (!hasCareerStar) {
          ê²°ê³¼.daYunPrints.push("å½“å‰é˜¶æ®µæš‚æ— æ˜¾è‘—å­¦æœ¯/äº‹ä¸šå‰æ˜Ÿã€‚");
        }

        // æ‹©å‰åˆ†æ
        ê²°ê³¼.dateRecPrints.push(`ğŸ“… æœªæ¥${analysisDays}å¤©æ‹©å‰æ¨èï¼ˆä»»åŠ¡ï¼š${task}ï¼‰\n` + "=".repeat(30));
        const allResults = [];
        const startDate = new Date(currentTime);
        for (let i = 0; i < analysisDays; i++) {
          const d = new Date(startDate);
          d.setDate(startDate.getDate() + i);
          const dateStr = d.toISOString().split('T')[0];
          const r = evaluateDayForTask(dateStr, task, qiangruo.yongShen, qiangruo.jiShen, eightChar.getDayGan(), currentDaYunTenGod, currentLiuNianTenGod, currentLiuYueTenGod);
          allResults.push(r);
        }
        
        allResults.sort((a, b) => b.score - a.score); // Sort by score descending
        
        const goodDays = allResults.filter(r => r.score >= 70); // Threshold for "good" day
        
        if (goodDays.length > 0) {
          ê²°ê³¼.dateRecPrints.push(`\nğŸ‰ æ‰¾åˆ° ${goodDays.length} ä¸ªé«˜åˆ†æ¨èæ—¥ (å¾—åˆ†>=70):`);
          goodDays.slice(0,5).forEach((day, idx) => { // Show top 5 good days
            ê²°ê³¼.dateRecPrints.push(`\nğŸ¯ æ¨èæ—¥ ${idx + 1}: ${day.date} | å¾—åˆ†: ${day.score}`);
            ê²°ê³¼.dateRecPrints.push(`   æ—¥æŸ±: ${day.ganzhi} (äº”è¡Œ:${day.wuxing})`);
            ê²°ê³¼.dateRecPrints.push(`   å‰ç¥: ${day.jiShen.join('ã€') || 'æ— ç‰¹å®š'}`);
            ê²°ê³¼.dateRecPrints.push(`   å‡¶ç…: ${day.xiongSha.join('ã€') || 'æ— ç‰¹å®š'}`);
          });
        } else {
          ê²°ê³¼.dateRecPrints.push(`\nâš ï¸ æœªæ‰¾åˆ°å¾—åˆ† >= 70 çš„é«˜åˆ†æ¨èæ—¥ï¼Œåˆ—å‡ºå¾—åˆ†æœ€é«˜çš„å‰3æ—¥ï¼š`);
          allResults.slice(0, 3).forEach((day, idx) => {
            ê²°ê³¼.dateRecPrints.push(`\nğŸ… æ½œåŠ›æ—¥ ${idx + 1}: ${day.date} | å¾—åˆ†: ${day.score}`);
            ê²°ê³¼.dateRecPrints.push(`   æ—¥æŸ±: ${day.ganzhi} (äº”è¡Œ:${day.wuxing})`);
            ê²°ê³¼.dateRecPrints.push(`   å‰ç¥: ${day.jiShen.join('ã€') || 'æ— ç‰¹å®š'}`);
            ê²°ê³¼.dateRecPrints.push(`   å‡¶ç…: ${day.xiongSha.join('ã€') || 'æ— ç‰¹å®š'}`);
          });
        }
        return ê²°ê³¼;
        
      } catch (e) {
        console.error("Analysis Error:", e);
        ê²°ê³¼.baziPrints.push(`åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${e.message}\n${e.stack}`);
        return ê²°ê³¼;
      }
    }
    
    // ==================== è¡¨å•æäº¤å‡½æ•° ====================
    
    function submitForm() {
      const birth = document.getElementById('birth').value;
      const gender = parseInt(document.getElementById('gender').value);
      const task = document.getElementById('task').value;
      const analysisDays = parseInt(document.getElementById('days').value);

      if (!birth) {
        alert("âš ï¸ è¯·è¾“å…¥å‡ºç”Ÿæ—¥æœŸå’Œæ—¶é—´ï¼");
        return;
      }
      if (analysisDays < 1 || analysisDays > 365) {
        alert("âš ï¸ åˆ†æå¤©æ•°å¿…é¡»åœ¨1-365ä¹‹é—´ï¼");
        return;
      }

      const resultBox = document.getElementById('result');
      resultBox.className = 'loading';
      resultBox.innerText = "â³ æ­£åœ¨åˆ†æå…«å­—ä¿¡æ¯ï¼Œè¯·ç¨å€™...";

      setTimeout(() => {
        try {
          const birthDateTime = new Date(birth);
          const currentTime = new Date();
          
          const analysisResult = runBaziAnalysis(birthDateTime, gender, task, analysisDays, currentTime);
          
          resultBox.className = 'success';
          
          let formattedOutput = "";
          formattedOutput += analysisResult.dateRecPrints.join("\n") + "\n\n";
          formattedOutput += analysisResult.baziPrints.join("\n") + "\n\n";
          formattedOutput += analysisResult.daYunPrints.join("\n");
          
          resultBox.innerText = formattedOutput;
          
        } catch (error) {
          resultBox.className = 'error';
          resultBox.innerText = "âŒ åˆ†æä¸»æµç¨‹å¤±è´¥ï¼š" + error.message + "\n" + error.stack;
          console.error('ä¸»æµç¨‹é”™è¯¯:', error);
        }
      }, 100); // Reduced timeout for faster feedback
    }

    window.onload = function() {
      const defaultDate = new Date('1990-01-01T12:00');
      document.getElementById('birth').value = defaultDate.toISOString().slice(0, 16);
    };
  </script>
</body>
</html>
